<html><head>
<script type='text/javascript' src='https://www.gstatic.com/charts/loader.js'></script>
    <script type='text/javascript'>
	google.charts.load('current', {'packages':['corechart']});
	google.charts.setOnLoadCallback(drawChart);
	function drawChart() {

	var duration = '3d'

  fetch('http://hub.hartcode.com/door/sensor/list').then(function (response) {
    if (response.status >= 400) {
      throw new Error('Bad response from server')
    }
    return response.json()
  }).then(function (sensorjson) {
    fetch('http://hub.hartcode.com/door/' + duration + '/graph').then(function (response) {
      if (response.status >= 400) {
        throw new Error('Bad response from server')
      }
      return response.json()
    }).then(function (json) {

	var arraydata = [];
	var titleRow = ['Time'] ;
	sensorjson.forEach(function(sensor) {
	  var sensorName = sensor.sensorId;
	  if ('name' in sensor) {
	    sensorName = sensor.name;
	  }            titleRow.push(sensorName);
    });
	arraydata.push(titleRow) ;
	var lastArrayRow = [null,0,0,0,0,0,0,0,0];
	json.forEach(function (element)  {
	  var arrayRow = [new Date(element._id.minute)] ;
	  for(var i = 0; i< sensorjson.length; i++) {
	    var sensor = sensorjson[i]

	    var tempData = lastArrayRow[i+1];
	    element.results.forEach(function(temp) {
	      if (sensor.sensorId == temp.sensorId) {
        if (temp.isOpen == true) {
          tempData = 1
        } else {
		      tempData = 0
        }
		  }
		});
		arrayRow.push(tempData);
	  }
	  arraydata.push(arrayRow);
	  lastArrayRow = arrayRow;
	});
   var data = google.visualization.arrayToDataTable(arraydata) ;
	var options = {
	title: 'Doors',
	curveType: 'none',
	legend: { position: 'bottom'} };
	var chartdiv = document.createElement('div');
	chartdiv.setAttribute('style','width: 900px height: 500px');
	document.body.appendChild(chartdiv);
	var chart = new google.visualization.LineChart(chartdiv);
	chart.draw(data, options);
	 }).catch(function (err) {
      console.log(err)
    })
  }).catch(function (err) {
    console.log(err)
  })
	}</script> </head><body></body></html>
